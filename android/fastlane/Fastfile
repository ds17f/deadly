# Android Fastlane Configuration
# This file contains the fastlane.tools configuration for Android builds

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:android)

platform :android do
  desc "Build debug APK"
  lane :build_debug do
    gradle(
      project_dir: "../",
      task: ":composeApp:assembleDebug",
      print_command: true
    )
  end

  desc "Build signed release APK"
  lane :build_release do
    # Ensure keystore.properties exists
    unless File.exist?("../.secrets/keystore.properties")
      UI.user_error!("❌ .secrets/keystore.properties not found. Please configure signing credentials.")
    end

    gradle(
      project_dir: "../",
      task: ":composeApp:assembleRelease",
      print_command: true
    )

    UI.success("✅ Signed release APK built successfully!")
  end

  desc "Build signed release App Bundle (AAB)"
  lane :build_bundle do
    # Ensure keystore.properties exists
    unless File.exist?("../.secrets/keystore.properties")
      UI.user_error!("❌ .secrets/keystore.properties not found. Please configure signing credentials.")
    end

    gradle(
      project_dir: "../",
      task: ":composeApp:bundleRelease",
      print_command: true
    )

    UI.success("✅ Signed release AAB built successfully!")
  end

  desc "Install debug APK to connected device"
  lane :deploy_device do
    # Check for connected device
    devices = sh("adb devices | grep -c 'device$' || true").strip.to_i
    if devices == 0
      UI.user_error!("❌ No Android device detected. Please connect a device with USB debugging enabled.")
    end

    gradle(
      project_dir: "../",
      task: ":composeApp:installDebug",
      print_command: true
    )

    # Launch the app
    sh("adb shell am start -n com.grateful.deadly/com.grateful.deadly.MainActivity")

    UI.success("✅ App installed and launched on device!")
  end

  desc "Install signed release APK to connected device"
  lane :deploy_device_release do
    # Check for connected device
    devices = sh("adb devices | grep -c 'device$' || true").strip.to_i
    if devices == 0
      UI.user_error!("❌ No Android device detected. Please connect a device with USB debugging enabled.")
    end

    # Build release APK
    build_release

    # Find and install the APK
    apk_path = Dir.glob("../composeApp/build/outputs/apk/release/*.apk").first
    if apk_path.nil?
      UI.user_error!("❌ No APK found in release directory")
    end

    sh("adb install -r '#{apk_path}'")

    # Launch the app
    sh("adb shell am start -n com.grateful.deadly/com.grateful.deadly.MainActivity")

    UI.success("✅ Signed release app installed and launched on device!")
  end

  desc "Run tests"
  lane :test do
    gradle(
      project_dir: "../",
      task: ":composeApp:test",
      print_command: true
    )
  end

  desc "Deploy to Play Store Internal Testing"
  lane :deploy_internal do
    build_bundle

    upload_to_play_store(
      track: 'internal',
      aab: '../composeApp/build/outputs/bundle/release/composeApp-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    UI.success("✅ App deployed to Play Store Internal Testing!")
  end
end
